<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>Photo Editor - Passport Photo Maker</title>
    <meta name="title" content="Photo Editor - Passport Photo Maker">
    <meta name="description" content="Edit and prepare your passport photo with professional tools. Adjust, crop, validate face position with AI. Create perfect passport photos.">
    <meta name="keywords" content="passport photo editor, photo crop tool, face validation, passport photo preparation, photo adjustment, photo editor online">
    <meta name="author" content="Photo Sheet Maker">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://aniltv06.github.io/passportphotosheet/photo-editor.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aniltv06.github.io/passportphotosheet/photo-editor.html">
    <meta property="og:title" content="Photo Editor - Passport Photo Maker">
    <meta property="og:description" content="Professional passport photo editor with AI face validation. Adjust, crop, and prepare perfect passport photos.">
    <meta property="og:image" content="https://aniltv06.github.io/passportphotosheet/og-image.jpg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://aniltv06.github.io/passportphotosheet/photo-editor.html">
    <meta name="twitter:title" content="Photo Editor - Passport Photo Maker">
    <meta name="twitter:description" content="Professional passport photo editor with AI face validation.">

    <!-- Theme and Mobile -->
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Photo Editor">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">

    <!-- Dynamic Cache Control - Automatically manages cache based on environment -->
    <!-- Development: Disables cache for easier testing -->
    <!-- Production: Enables cache for better performance -->
    <script type="module" src="js/meta-loader.js"></script>

    <!-- MediaPipe Libraries for Face Detection with CDN Fallback -->
    <script>
        // CDN Fallback System for MediaPipe
        // Tries multiple CDNs and gracefully degrades if all fail

        (function() {
            const cdnSources = {
                selfieSegmentation: [
                    'https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1/selfie_segmentation.js',
                    'https://unpkg.com/@mediapipe/selfie_segmentation@0.1/selfie_segmentation.js'
                ],
                faceDetection: [
                    'https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4/face_detection.js',
                    'https://unpkg.com/@mediapipe/face_detection@0.4/face_detection.js'
                ]
            };

            let loadAttempts = {
                selfieSegmentation: 0,
                faceDetection: 0
            };

            // Load script with fallback
            function loadScriptWithFallback(urls, libraryName, callback) {
                const currentIndex = loadAttempts[libraryName];

                if (currentIndex >= urls.length) {
                    console.error(`Failed to load ${libraryName} from all CDN sources`);
                    callback(false);
                    return;
                }

                const script = document.createElement('script');
                script.src = urls[currentIndex];

                script.onload = () => {
                    console.log(`‚úì Loaded ${libraryName} from CDN ${currentIndex + 1}`);
                    callback(true);
                };

                script.onerror = () => {
                    console.warn(`‚úó Failed to load ${libraryName} from CDN ${currentIndex + 1}, trying next...`);
                    loadAttempts[libraryName]++;

                    // Track CDN failure
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'cdn_fallback', {
                            'event_category': 'Performance',
                            'event_label': libraryName,
                            'value': currentIndex
                        });
                    }

                    // Try next CDN
                    loadScriptWithFallback(urls, libraryName, callback);
                };

                document.head.appendChild(script);
            }

            // Load both libraries
            let selfieLoaded = false;
            let faceLoaded = false;

            function checkAllLoaded() {
                if (selfieLoaded !== null && faceLoaded !== null) {
                    if (!selfieLoaded || !faceLoaded) {
                        // At least one library failed to load
                        console.warn('MediaPipe libraries unavailable - Face validation will be limited');
                        window.mediaPipeAvailable = false;

                        // Show user notification
                        document.addEventListener('DOMContentLoaded', () => {
                            const validationResults = document.getElementById('validationResults');
                            if (validationResults) {
                                const lang = localStorage.getItem('preferredLanguage') || 'en';
                                const trans = window.translations?.[lang] || window.translations?.en || {};

                                validationResults.style.display = 'block';
                                validationResults.style.background = '#FFF3CD';
                                validationResults.style.borderLeft = '4px solid #FFA500';
                                validationResults.innerHTML = `
                                    <strong style="color: #856404;">${trans.faceValidationLimitedTitle || '‚ö†Ô∏è Limited Functionality'}</strong>
                                    <p style="color: #856404; margin-top: 8px; font-size: 13px;">
                                        ${trans.faceValidationLimitedDesc || 'Face detection libraries couldn\'t be loaded. Face validation feature is unavailable. All other editing features work normally.'}
                                    </p>
                                `;
                            }
                        });
                    } else {
                        window.mediaPipeAvailable = true;
                    }
                }
            }

            // Start loading
            loadScriptWithFallback(
                cdnSources.selfieSegmentation,
                'selfieSegmentation',
                (success) => {
                    selfieLoaded = success;
                    checkAllLoaded();
                }
            );

            loadScriptWithFallback(
                cdnSources.faceDetection,
                'faceDetection',
                (success) => {
                    faceLoaded = success;
                    checkAllLoaded();
                }
            );
        })();
    </script>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHSENQTDSF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-BHSENQTDSF', {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure',
            'page_path': '/photo-editor.html'
        });

        // Track page view
        gtag('event', 'page_view', {
            page_title: 'Photo Editor',
            page_location: window.location.href,
            page_path: '/photo-editor.html'
        });
    </script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "u9f5jiwh0y");
    </script>

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Photo Editor - Passport Photo Maker",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Any",
      "description": "Professional passport photo editor with AI face validation. Adjust, crop, and prepare perfect passport photos with guidelines.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Upload and crop passport photos",
        "AI-powered face validation",
        "Zoom and rotation controls",
        "US passport guideline overlay",
        "Grid with scale measurements",
        "High-quality 300 DPI output",
        "Privacy-focused (no server upload)",
        "Free forever"
      ],
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
      "author": {
        "@type": "Organization",
        "name": "Photo Sheet Maker"
      }
    }
    </script>

    <!-- Photo Editor Styles -->
    <link rel="stylesheet" href="css/photo-editor-styles.css">

    <!-- UX Component Styles -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/ux-components.css">
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- NAVIGATION HEADER -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <!-- Logo -->
            <a href="index.html" class="nav-logo" aria-label="Home">
                üì∏ Photo Sheet Maker
            </a>

            <!-- Navigation Links -->
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <span data-i18n="photoMaker">Photo Maker</span>
                </a>
                <a href="photo-editor.html" class="nav-link featured active" aria-current="page">
                    ‚úÇÔ∏è <span data-i18n="photoEditor">Photo Editor</span>
                </a>
                <a href="faq.html" class="nav-link">
                    <span data-i18n="help">Help</span>
                </a>
            </div>

            <!-- Language Selector -->
            <select id="languageSelect" class="nav-language" aria-label="Select language">
                <option value="en">üá∫üá∏ English</option>
                <option value="es">üá™üá∏ Espa√±ol</option>
                <option value="fr">üá´üá∑ Fran√ßais</option>
                <option value="de">üá©üá™ Deutsch</option>
                <option value="pt">üáµüáπ Portugu√™s</option>
                <option value="it">üáÆüáπ Italiano</option>
                <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            </select>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
                ‚ò∞
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
    <div class="container">
        <main id="main-content" class="editor-layout" role="main">
            <!-- Left Panel: Upload & Guidelines -->
            <div class="left-panel">
                <div class="panel">
                    <h3 data-i18n="upload_title">1. Upload Photo</h3>
                    <!-- Upload UI will be dynamically generated by photoHandler.js -->
                    <div id="uploadContainer"></div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h3 data-i18n="guidelines_title">Guidelines</h3>
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <span class="toggle-label" id="faceGuideLabel" data-i18n="face_outline">Face Outline</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="toggleFaceGuide" checked
                                       role="switch" aria-checked="true" aria-labelledby="faceGuideLabel">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label" id="gridLabel" data-i18n="grid_scale">Grid with Scale</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="toggleGrid"
                                       role="switch" aria-checked="false" aria-labelledby="gridLabel">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div id="instructionsPanel" class="instructions" style="margin-top: 20px;">
                        <div class="instructions-header" onclick="toggleInstructions()" role="button" tabindex="0" aria-expanded="true" aria-controls="instructionsContent">
                            <strong>
                                <span>üìã</span>
                                <span>US Passport Requirements</span>
                            </strong>
                            <span class="collapse-icon" aria-hidden="true">‚ñº</span>
                        </div>
                        <div id="instructionsContent" class="instructions-content">
                            <ul>
                                <li>Head height: 1" to 1-3/8"</li>
                                <li>Face centered horizontally</li>
                                <li>Neutral expression</li>
                                <li>White/off-white background</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Column: Canvas + Export -->
            <div>
                <!-- Canvas Panel -->
                <div class="canvas-panel panel" id="canvasPanel">
                    <div id="uploadPrompt">
                        <div style="text-align: center; color: var(--text-secondary);">
                            <div style="font-size: 64px; margin-bottom: 16px;">üì∏</div>
                            <h3 style="font-size: 20px; margin-bottom: 8px; color: var(--text-primary);">Upload a photo to get started</h3>
                            <p>Select a photo from the left panel</p>
                        </div>
                    </div>
                    <div id="canvasContainer" class="canvas-container" style="display: none;"
                         aria-label="Passport photo editing canvas">
                        <canvas id="editCanvas" aria-label="Main editing canvas"></canvas>
                        <canvas id="overlayCanvas" class="overlay-canvas" aria-hidden="true"></canvas>
                        <!-- Touch Gesture Hints for Mobile -->
                        <div class="touch-hints" aria-live="polite">
                            <div class="touch-hint-icon">üëÜ</div>
                            Pinch to zoom ‚Ä¢ Drag to move
                        </div>
                    </div>
                    <div id="photoInfo" style="display: none; text-align: center; margin-top: 16px; padding: 12px; background: rgba(0, 122, 255, 0.05); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <strong style="color: var(--text-primary);">Photo Specifications</strong><br>
                        <span style="display: inline-block; margin-top: 6px;">
                            <strong>Size:</strong> 2√ó2 inches (51√ó51 mm) ‚Ä¢
                            <strong>Resolution:</strong> 600√ó600 pixels @ 300 DPI
                        </span>
                    </div>
                </div>

                <!-- Export Panel - Separate panel below canvas -->
                <div class="panel" style="margin-top: 20px;">
                    <h3>Export</h3>
                    <button class="btn btn-success" id="exportBtn" disabled
                            aria-label="Use this photo to create a photo sheet - returns to the main photo maker page">
                        ‚úì Create Photo Sheet
                    </button>
                    <button class="btn btn-secondary" id="downloadBtn" disabled
                            aria-label="Download edited photo as JPEG file to your device">
                        ‚¨á Download to Device
                    </button>
                </div>
            </div>

            <!-- Right Panel: Controls -->
            <div class="right-panel">
                <div class="panel">
                    <h3>2. Adjust Photo</h3>

                    <div class="info-badge">
                        <strong>üí° Quick Tips</strong>
                        Drag to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Align face with guides
                    </div>

                    <div class="control-group">
                        <label class="control-label" for="zoomSlider">Zoom</label>
                        <div class="slider-container">
                            <input type="range" id="zoomSlider" class="slider"
                                   min="0.1" max="3" step="0.01" value="1"
                                   aria-label="Zoom level" aria-valuemin="0.1" aria-valuemax="3" aria-valuenow="1" aria-valuetext="100%">
                            <span class="slider-value" id="zoomValue" aria-live="polite">100%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label" for="rotationSlider">Rotation</label>
                        <div class="slider-container">
                            <input type="range" id="rotationSlider" class="slider"
                                   min="-45" max="45" step="0.1" value="0"
                                   aria-label="Rotation angle" aria-valuemin="-45" aria-valuemax="45" aria-valuenow="0" aria-valuetext="0 degrees">
                            <span class="slider-value" id="rotationValue" aria-live="polite">0¬∞</span>
                        </div>
                    </div>

                    <button class="btn btn-secondary" id="resetBtn" disabled
                            aria-label="Reset photo position, zoom, and rotation to defaults">
                        ‚Üª Reset Position
                    </button>

                    <!-- Keyboard Shortcuts Info -->
                    <div class="info-badge" style="margin-top: 16px; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-color: rgba(0, 122, 255, 0.2);">
                        <strong>‚å®Ô∏è Keyboard Shortcuts</strong>
                        <div style="font-size: 12px; margin-top: 8px; line-height: 1.6;">
                            ‚Ä¢ <kbd>+</kbd> / <kbd>-</kbd> Zoom in/out<br>
                            ‚Ä¢ <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Rotate left/right<br>
                            ‚Ä¢ <kbd>R</kbd> Reset position<br>
                            ‚Ä¢ <kbd>C</kbd> Toggle crop mode<br>
                            ‚Ä¢ <kbd>V</kbd> Validate face<br>
                            ‚Ä¢ <kbd>Esc</kbd> Cancel crop
                        </div>
                    </div>
                </div>

                <!-- Crop Tool Section -->
                <div class="panel" style="margin-top: 20px;">
                    <h3>2b. Crop Tool</h3>

                    <button class="btn btn-primary" id="cropModeBtn" disabled
                            aria-label="Toggle crop mode to define crop area">
                        ‚úÇÔ∏è Enable Crop Mode
                    </button>

                    <div id="cropInstructions" style="display: none; margin-top: 16px; padding: 12px; background: rgba(0, 122, 255, 0.05); border-radius: 8px; border: 1px solid rgba(0, 122, 255, 0.2);">
                        <strong style="color: var(--primary-color); font-size: 14px;">üìê Crop Mode Active</strong>
                        <p style="font-size: 13px; margin-top: 8px; color: var(--text-secondary);">
                            Click and drag on the image to define the crop area. The red rectangle shows what will be kept.
                        </p>
                        <p style="font-size: 12px; margin-top: 6px; color: var(--text-secondary); font-style: italic;">
                            Note: Pan and zoom are disabled during crop mode.
                        </p>
                    </div>

                    <div id="cropControls" style="display: none; margin-top: 16px;">
                        <button class="btn btn-success" id="applyCropBtn"
                                aria-label="Apply the crop and keep only the selected area">
                            ‚úì Apply Crop
                        </button>
                        <button class="btn btn-secondary" id="cancelCropBtn"
                                aria-label="Cancel crop mode and return to normal editing">
                            ‚úï Cancel
                        </button>
                    </div>
                </div>

                <!-- Background Removal Section - Hidden for future improvements -->
                <!--
                <div class="panel" style="margin-top: 20px;">
                    <h3>3. Background</h3>

                    <button class="btn btn-primary" id="removeBackgroundBtn" disabled>
                        üé® Remove Background
                    </button>

                    <div class="control-group">
                        <label class="control-label">Background Color</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <button class="bg-color-btn" data-color="#FFFFFF"
                                    style="background: white; border: 2px solid #ddd; height: 40px; border-radius: 8px; cursor: pointer;">
                                White
                            </button>
                            <button class="bg-color-btn" data-color="#F5F5F0"
                                    style="background: #F5F5F0; border: 2px solid #ddd; height: 40px; border-radius: 8px; cursor: pointer;">
                                Off-White
                            </button>
                            <button class="bg-color-btn" data-color="#E8E8E8"
                                    style="background: #E8E8E8; border: 2px solid #ddd; height: 40px; border-radius: 8px; cursor: pointer;">
                                Light Gray
                            </button>
                        </div>
                    </div>

                    <div id="loadingIndicator" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <div class="processing-text">Processing...</div>
                    </div>
                </div>
                -->

                <div class="panel" style="margin-top: 20px;">
                    <h3>3. Face Validation</h3>

                    <button class="btn btn-primary" id="validateFaceBtn" disabled
                            aria-label="Check if face position meets passport photo requirements">
                        üë§ Check Face Position
                    </button>

                    <div id="validationResults" style="display: none; margin-top: 16px; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6;"
                         role="status" aria-live="polite">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    </div>

    <!-- Footer Container - Loaded from components/footer.html -->
    <div id="footer-container"></div>

    <!-- Load translations from modular structure -->
    <script type="module" src="translations/index.js"></script>

    <!-- Translation Functions -->
    <script type="module">
        // Wait for translations to be loaded
        function waitForTranslations(callback) {
            if (window.translations && typeof window.translations === 'object') {
                callback();
            } else {
                // Check again in 50ms
                setTimeout(() => waitForTranslations(callback), 50);
            }
        }

        // Translation helper function
        window.t = function(key, fallback = '') {
            const lang = window.getLanguage();
            return window.translations?.[lang]?.[key] || window.translations?.en?.[key] || fallback;
        };

        // Get or set language preference
        window.getLanguage = function() {
            return localStorage.getItem('preferredLanguage') || 'en';
        };

        window.setLanguage = function(lang) {
            localStorage.setItem('preferredLanguage', lang);
        };

        // Apply translations to the page
        window.applyTranslations = function(lang) {
            // Ensure translations object exists
            if (!window.translations || typeof window.translations !== 'object') {
                console.warn('Translations not loaded yet, waiting...');
                return;
            }

            const trans = window.translations[lang] || window.translations.en;

            // Safety check - ensure trans has data
            if (!trans || typeof trans !== 'object') {
                console.warn(`Translation for language "${lang}" not found, using English fallback`);
                return;
            }

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (trans[key]) {
                    element.textContent = trans[key];
                }
            });

            // Update document title
            if (trans.page_title) {
                document.title = trans.page_title + " - Passport Photo Maker";
            }

            // Track language change
            if (typeof gtag !== 'undefined') {
                gtag('event', 'language_changed', {
                    'event_category': 'Localization',
                    'event_label': lang
                });
            }
        };

        // Initialize translations when ready
        function initTranslations() {
            waitForTranslations(() => {
                const languageSelect = document.getElementById('languageSelect');
                const currentLang = window.getLanguage();

                if (languageSelect) {
                    // Set initial language
                    languageSelect.value = currentLang;

                    // Handle language change
                    languageSelect.addEventListener('change', (e) => {
                        const newLang = e.target.value;
                        window.setLanguage(newLang);
                        window.applyTranslations(newLang);
                        console.log(`Language changed to: ${newLang}`);
                    });
                }

                // Apply initial translations
                window.applyTranslations(currentLang);
            });
        }

        // Initialize on DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTranslations);
        } else {
            initTranslations();
        }
    </script>

    <!-- ================================================== -->
    <!-- Photo Editor App Module Integration -->
    <!-- ================================================== -->
    <script type="module">
        import { initPhotoEditorApp } from './js/editor-app.js';

        // Initialize the photo editor application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the photo editor app
            initPhotoEditorApp();

            // Connect with photo handler (from photoHandler-editor.js)
            // The photo handler will call window.photoEditorApp.onPhotoLoaded
            // when a photo is loaded
        });
    </script>

    <!-- UX Components Initialization -->
    <script type="module">
        import { initMobileNav, initStickyNav } from './js/ux-components.js';

        // Import common utilities
        import { initCommon } from './js/common.js';

        // Initialize basic UX components
        document.addEventListener('DOMContentLoaded', async () => {
            // Load footer first
            await initCommon();

            initMobileNav();
            initStickyNav();
        });
    </script>

    <!-- ================================================== -->
    <!-- Photo Handler Module Integration -->
    <!-- ================================================== -->
    <script type="module">
        import { PhotoStorage } from './js/photoHandler.js';
        import {
            initPhotoEditorUpload,
            handleUsePhoto,
            handleDownloadPhoto
        } from './js/photoHandler-editor.js';

        // Photo handler and storage instances
        let photoHandler = null;
        const photoStorage = new PhotoStorage();

        // Initialize function
        function initializePhotoHandler() {
            // Get current language for translations
            const currentLang = window.getLanguage();
            const trans = window.translations[currentLang] || window.translations.en;

            // Initialize photo upload with image loading callback
            photoHandler = initPhotoEditorUpload(
                trans,
                (image, dataURL, metadata) => {
                    console.log('Photo loaded via photoHandler:', metadata);

                    // Call the photo editor app's onPhotoLoaded method
                    if (window.photoEditorApp) {
                        window.photoEditorApp.onPhotoLoaded(image, dataURL, metadata);
                    } else {
                        console.error('PhotoEditorApp not initialized yet');
                    }
                }
            );

            console.log('Photo handler initialized for photo editor');
        }

        // Call immediately if DOM already loaded, otherwise wait for DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePhotoHandler);
        } else {
            // DOM is already loaded, initialize immediately
            initializePhotoHandler();
        }

        // Note: Export and Download button handlers are now in editor-app.js
        // The PhotoExporter module handles all export functionality

        // Update upload text when language changes
        // Hook into existing applyTranslations function
        const originalApplyTranslations = window.applyTranslations;
        if (typeof originalApplyTranslations === 'function') {
            window.applyTranslations = function(lang) {
                // Call original translation function
                originalApplyTranslations(lang);

                // Update photo handler text
                if (photoHandler && window.translations[lang]) {
                    const trans = window.translations[lang];
                    photoHandler.updateText({
                        uploadText: trans.upload_text || 'Choose Your Photo',
                        uploadHint: trans.upload_hint || 'Click or drag and drop',
                        successMessage: trans.uploadSuccess || 'Photo uploaded successfully'
                    });
                }
            };
        }

        // Make instances accessible globally for debugging
        window.photoHandler = photoHandler;
        window.photoStorage = photoStorage;
    </script>
</body>
</html>
